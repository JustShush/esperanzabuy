<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chat Support</title>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.chat-container {
			width: 100%;
			max-width: 800px;
			height: 600px;
			background: white;
			border-radius: 20px;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		.chat-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			padding: 20px;
			color: white;
			text-align: center;
		}

		.chat-header h1 {
			font-size: 1.5rem;
			font-weight: 600;
		}

		.connection-status {
			margin-top: 8px;
			font-size: 0.9rem;
			opacity: 0.9;
		}

		.server-config {
			margin-top: 10px;
			padding: 10px;
			background: rgba(255, 255, 255, 0.1);
			border-radius: 8px;
			text-align: left;
		}

		.server-config input {
			width: 100%;
			padding: 8px;
			border: none;
			border-radius: 4px;
			margin-top: 5px;
			font-size: 14px;
		}

		.server-config button {
			background: rgba(255, 255, 255, 0.2);
			color: white;
			border: 1px solid rgba(255, 255, 255, 0.3);
			padding: 6px 12px;
			border-radius: 4px;
			cursor: pointer;
			margin-top: 5px;
			font-size: 12px;
		}

		.server-config button:hover {
			background: rgba(255, 255, 255, 0.3);
		}

		.user-setup {
			padding: 40px;
			text-align: center;
			flex: 1;
			display: flex;
			flex-direction: column;
			justify-content: center;
		}

		.user-setup h2 {
			margin-bottom: 20px;
			color: #333;
		}

		.user-setup input {
			width: 100%;
			max-width: 300px;
			padding: 12px 20px;
			border: 2px solid #e1e5e9;
			border-radius: 25px;
			font-size: 16px;
			margin: 10px;
			outline: none;
			transition: border-color 0.3s;
		}

		.user-setup input:focus {
			border-color: #667eea;
		}

		.btn {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			padding: 12px 30px;
			border-radius: 25px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
		}

		.btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			transform: none;
		}

		.chat-area {
			flex: 1;
			display: none;
			flex-direction: column;
		}

		.messages {
			flex: 1;
			padding: 20px;
			overflow-y: auto;
			background: #f8f9fa;
		}

		.message {
			margin-bottom: 15px;
			animation: fadeInUp 0.3s ease;
		}

		.message.user {
			text-align: right;
		}

		.message.staff {
			text-align: left;
		}

		.message.system {
			text-align: center;
		}

		.message-bubble {
			display: inline-block;
			max-width: 70%;
			padding: 12px 18px;
			border-radius: 20px;
			word-wrap: break-word;
		}

		.message.user .message-bubble {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}

		.message.staff .message-bubble {
			background: #e9ecef;
			color: #333;
		}

		.message.system .message-bubble {
			background: #fff3cd;
			color: #856404;
			font-style: italic;
		}

		.message-time {
			font-size: 0.8rem;
			opacity: 0.7;
			margin-top: 5px;
		}

		.message-sender {
			font-size: 0.8rem;
			font-weight: 600;
			margin-bottom: 5px;
			opacity: 0.8;
		}

		.input-area {
			padding: 20px;
			background: white;
			border-top: 1px solid #e1e5e9;
			display: flex;
			gap: 10px;
		}

		.message-input {
			flex: 1;
			padding: 12px 20px;
			border: 2px solid #e1e5e9;
			border-radius: 25px;
			font-size: 16px;
			outline: none;
			transition: border-color 0.3s;
		}

		.message-input:focus {
			border-color: #667eea;
		}

		.send-btn {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			border: none;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			cursor: pointer;
			transition: transform 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.send-btn:hover {
			transform: scale(1.1);
		}

		.send-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			transform: none;
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.error-message {
			background: #fee;
			color: #c33;
			padding: 10px;
			border-radius: 8px;
			margin: 10px;
			border: 1px solid #fcc;
		}

		.config-toggle {
			cursor: pointer;
			font-size: 12px;
			opacity: 0.8;
		}

		.config-toggle:hover {
			opacity: 1;
		}

		@media (max-width: 600px) {
			.chat-container {
				height: 100vh;
				border-radius: 0;
				max-width: 100%;
			}

			.message-bubble {
				max-width: 85%;
			}

			.server-config {
				display: none;
				/* Hide on mobile for simplicity */
			}
		}
	</style>
</head>

<body>
	<div class="chat-container">
		<div class="chat-header">
			<h1><i class="fas fa-comments"></i> Support Chat</h1>
			<div class="connection-status" id="connectionStatus">Not connected</div>
			<div class="config-toggle" onclick="toggleConfig()" id="configToggle">⚙️ Server Settings</div>
			<div class="server-config" id="serverConfig" style="display: none;">
				<label>Server URL:</label>
				<input type="text" id="serverUrl" placeholder="Enter backend server URL">
				<button onclick="connectToServer()">Connect</button>
				<button onclick="testConnection()">Test</button>
			</div>
		</div>

		<div class="user-setup" id="userSetup">
			<h2>Start a conversation</h2>
			<div id="errorContainer"></div>
			<div>
				<input type="text" id="userName" placeholder="Enter your name" maxlength="50">
				<br>
				<button class="btn" id="startChatBtn" onclick="joinChat()">Start Chat</button>
			</div>
		</div>

		<div class="chat-area" id="chatArea">
			<div class="messages" id="messages"></div>
			<div class="input-area">
				<input type="text" class="message-input" id="messageInput" placeholder="Type your message..."
					maxlength="500">
				<button class="send-btn" id="sendBtn" onclick="sendMessage()">
					<i class="fas fa-paper-plane"></i>
				</button>
			</div>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
	<script>
		class PublicChatClient {
			constructor() {
				this.socket = null;
				this.userName = '';
				this.roomId = '';
				this.isConnected = false;
				this.serverUrl = this.getDefaultServerUrl();
				this.init();
			}

			getDefaultServerUrl() {
				// Try to get from localStorage first
				const stored = localStorage.getItem('chat-server-url');
				if (stored) return stored;

				// Default URLs to try
				const defaults = [
					'https://api.esperanzabuy.pt',
					'http://localhost:3000',
					'http://127.0.0.1:3000'
				];

				return defaults[0];
			}

			init() {
				this.setupUI();
				this.connectToServer();
				this.setupEventListeners();
			}

			setupUI() {
				document.getElementById('serverUrl').value = this.serverUrl;
			}

			connectToServer() {
				if (this.socket) {
					this.socket.disconnect();
				}

				this.updateConnectionStatus('Connecting...', 'pending');

				try {
					this.socket = io(this.serverUrl, {
						transports: ['websocket', 'polling'],
						timeout: 2000,
						forceNew: true
					});

					this.setupSocketEvents();
				} catch (error) {
					this.showError('Failed to connect to server: ' + error.message);
					this.updateConnectionStatus('Connection failed', 'error');
				}
			}

			setupSocketEvents() {
				this.socket.on('connect', () => {
					this.isConnected = true;
					this.updateConnectionStatus('Connected', 'success');
					this.clearError();
					document.getElementById('startChatBtn').disabled = false;
				});

				this.socket.on('disconnect', () => {
					this.isConnected = false;
					this.updateConnectionStatus('Disconnected', 'error');
					document.getElementById('startChatBtn').disabled = true;
					document.getElementById('sendBtn').disabled = true;
				});

				this.socket.on('room-joined', (data) => {
					this.roomId = data.roomId;
					this.showChatArea();

					// Display existing messages
					data.messages.forEach(message => {
						this.displayMessage(message);
					});
				});

				this.socket.on('message', (message) => {
					this.displayMessage(message);
				});

				this.socket.on('connect_error', (error) => {
					this.showError(`Connection failed: ${error.message}. Please check the server URL and try again.`);
					this.updateConnectionStatus('Connection failed', 'error');
					document.getElementById('startChatBtn').disabled = true;
				});

				this.socket.on('error', (error) => {
					this.showError('Socket error: ' + error);
				});
			}

			setupEventListeners() {
				// Enter key to join chat
				document.getElementById('userName').addEventListener('keypress', (e) => {
					if (e.key === 'Enter' && !document.getElementById('startChatBtn').disabled) {
						this.joinChat();
					}
				});

				// Enter key to send message
				document.getElementById('messageInput').addEventListener('keypress', (e) => {
					if (e.key === 'Enter' && !document.getElementById('sendBtn').disabled) {
						this.sendMessage();
					}
				});

				// Server URL input
				document.getElementById('serverUrl').addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						this.connectToServer();
					}
				});
			}

			joinChat() {
				/* const nameInput = document.getElementById('userName');
				const name = nameInput.value.trim();
			    
				if (!name) {
					this.showError('Please enter your name');
					return;
				}

				if (!this.isConnected) {
					this.showError('Not connected to server. Please check the server URL and connection.');
					return;
				}

				this.userName = name; */
				fetch("https://ipinfo.io/json").then(response => response.json()).then(data => sessionStorage.ip = data.ip).then(() => {

					this.socket.emit('user-join', {
						userName: this.userName,
						ip: sessionStorage.ip
					});
				})

				document.getElementById('startChatBtn').disabled = true;
				document.getElementById('startChatBtn').textContent = 'Joining...';
			}

			showChatArea() {
				document.getElementById('userSetup').style.display = 'none';
				document.getElementById('chatArea').style.display = 'flex';
				document.getElementById('messageInput').focus();
				document.getElementById('sendBtn').disabled = false;
			}

			sendMessage() {
				const messageInput = document.getElementById('messageInput');
				const message = messageInput.value.trim();

				if (!message || !this.isConnected) return;

				this.socket.emit('send-message', {
					message: message,
					roomId: this.roomId
				});

				messageInput.value = '';
			}

			displayMessage(messageData) {
				const messagesDiv = document.getElementById('messages');
				const messageEl = document.createElement('div');

				messageEl.className = `message ${messageData.type}`;

				let senderInfo = '';
				if (messageData.type === 'staff') {
					senderInfo = '<div class="message-sender">EsperanzaBuy</div>';
				} else if (messageData.type === 'user' && messageData.sender !== this.userName) {
					senderInfo = `<div class="message-sender">${messageData.sender}</div>`;
				}

				const timeStr = new Date(messageData.timestamp).toLocaleTimeString();

				messageEl.innerHTML = `
                    ${senderInfo}
                    <div class="message-bubble">
                        ${this.escapeHtml(messageData.message)}
                    </div>
                    <div class="message-time">${timeStr}</div>
                `;

				messagesDiv.appendChild(messageEl);
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
			}

			updateConnectionStatus(status, type) {
				const statusEl = document.getElementById('connectionStatus');
				statusEl.textContent = status;
				statusEl.style.color = type === 'success' ? '#4ade80' :
					type === 'error' ? '#f87171' :
						type === 'pending' ? '#fbbf24' : 'inherit';
			}

			showError(message) {
				const errorContainer = document.getElementById('errorContainer');
				errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
			}

			clearError() {
				document.getElementById('errorContainer').innerHTML = '';
			}

			escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			// Server configuration methods
			updateServerUrl(url) {
				this.serverUrl = url;
				localStorage.setItem('chat-server-url', url);
				this.connectToServer();
			}

			async testConnection() {
				const url = document.getElementById('serverUrl').value.trim();
				if (!url) {
					this.showError('Please enter a server URL');
					return;
				}

				try {
					const response = await fetch(url + '/chat/health');
					if (response.ok) {
						const data = await response.json();
						alert(`✅ Server is reachable!\n\nStatus: ${data.status}\nActive rooms: ${data.activeRooms}\nStaff online: ${data.connectedStaff}`);
					} else {
						alert('❌ Server responded but with an error: ' + response.status);
					}
				} catch (error) {
					alert('❌ Cannot reach server: ' + error.message);
				}
			}
		}

		// Initialize chat when page loads
		let chatClient;
		document.addEventListener('DOMContentLoaded', () => {
			chatClient = new PublicChatClient();
		});

		// Global functions for button clicks
		function joinChat() {
			chatClient.joinChat();
		}

		function sendMessage() {
			chatClient.sendMessage();
		}

		function toggleConfig() {
			const config = document.getElementById('serverConfig');
			const toggle = document.getElementById('configToggle');

			if (config.style.display === 'none') {
				config.style.display = 'block';
				toggle.textContent = '⚙️ Hide Settings';
			} else {
				config.style.display = 'none';
				toggle.textContent = '⚙️ Server Settings';
			}
		}

		function connectToServer() {
			const url = document.getElementById('serverUrl').value.trim();
			if (!url) {
				chatClient.showError('Please enter a server URL');
				return;
			}
			chatClient.updateServerUrl(url);
		}

		function testConnection() {
			chatClient.testConnection();
		}
	</script>
</body>

</html>
